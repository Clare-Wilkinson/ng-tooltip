
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: verification-svc
  annotations:
    kubernetes.io/ingress.class: 'repl{{ ConfigOption "ingress_class_name" }}'
    kots.io/placeholder: repl{{ printf "'true'" }}repl{{ ConfigOption "ingress_annotations" | nindent 4 }}
spec:
  rules:
    - http:
        paths:
          - backend:
              serviceName: verification-svc
              servicePort: 7070
            path: /verification
# repl{{ if ConfigOptionEquals "scheme" "https"}}
      host: '{{repl ConfigOption "host_name" }}'
  tls:
    - hosts:
      - '{{repl ConfigOption "host_name" }}'
      secretName: harness-cert  
# repl{{ end }}             


---
apiVersion: v1
metadata:
  name: verification-svc
data:
  DEPLOY_MODE: KUBERNETES_ONPREM
  LOGGING_LEVEL: INFO
  MANAGER_URL: http://harness-manager:9090/api/
  MEMORY: 'repl{{ ConfigOption "verification_memory" }}'
  VERIFICATION_PORT: "7070"
  VERSION: 1.0.68511
kind: ConfigMap

---
apiVersion: v1
kind: Secret
type: Opaque
metadata:
  name: verification-svc
stringData:
  VERIFICATION_SERVICE_SECRET: 59MR5RlVARcdH7zb7pNx6GzqiglBmXR8
  MONGO_URI: '{{repl if ConfigOptionEquals "mode" "production_ha"}}mongodb://admin:CA8FMywpbM@mongodb-replicaset-chart-0.mongodb-replicaset-chart.{{repl Namespace}}.svc,mongodb-replicaset-chart-1.mongodb-replicaset-chart.{{repl Namespace}}.svc,mongodb-replicaset-chart-2.mongodb-replicaset-chart.{{repl Namespace}}.svc:27017/harness?replicaSet=rs0&authSource=admin{{repl else}}mongodb://admin:CA8FMywpbM@mongodb-replicaset-chart-0.mongodb-replicaset-chart.{{repl Namespace}}.svc/harness?authSource=admin{{repl end}}'
---


apiVersion: v1
kind: Service
metadata:
  name: verification-svc
  labels:
    kots.io/placeholder: repl{{ printf "'true'" }}repl{{ ConfigOption "labels" | nindent 4 }} 
spec:
  ports:
    - name: verification
      port: 7070
      protocol: TCP
      targetPort: 7070
  selector:
    app: verification-svc
  sessionAffinity: None
  type: ClusterIP

---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: verification-svc
    kots.io/placeholder: repl{{ printf "'true'" }}repl{{ ConfigOption "labels" | nindent 4 }} 
  name: verification-svc
spec:
  replicas: repl{{ ConfigOption "verification_replica" }}
  selector:
    matchLabels:
      app: verification-svc
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: verification-svc
        kots.io/placeholder: repl{{ printf "'true'" }}repl{{ ConfigOption "labels" | nindent 8 }} 
      annotations:
        license-features-hash: '{{repl (sha256sum (print (LicenseFieldValue "license") (LicenseFieldValue "feature_flag") (ConfigOption "mode") (ConfigOption "loadbalancer_url") )) }}'      
    spec:
# repl{{ if ConfigOptionEquals "mode" "production_ha"}}      
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:	
            - labelSelector:	
                matchLabels:	
                  app: verification-svc	
              topologyKey: kubernetes.io/hostname
# repl{{ end }}                 
      serviceAccountName: harness-default
      initContainers:
        - name: check-for-mongo
          image: mongo:4.2
          command: ['sh', '-c', "until mongo \"$(cat /config/MONGO_URI)\" --eval \"db.adminCommand('ping')\"; do echo waiting for mongodb; sleep 2; done"]
          volumeMounts:
            - name: verification-svc
              mountPath: /config
          securityContext:
            runAsNonRoot: true
            runAsUser: 999
      containers:
        - envFrom:
            - configMapRef:
                name: verification-svc
            - secretRef:
                name: verification-svc
          image: harness/verification-service-signed:68511
          imagePullPolicy: IfNotPresent
          securityContext:
            runAsNonRoot: true
          livenessProbe:
            failureThreshold: 2
            httpGet:
              path: /verification/health
              port: verification
              scheme: HTTP
            initialDelaySeconds: 300
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 1
          name: verification
          ports:
            - containerPort: 7070
              name: verification
              protocol: TCP
          readinessProbe:
            failureThreshold: 3
            httpGet:
              path: /verification/health
              port: verification
              scheme: HTTP
            initialDelaySeconds: 60
            periodSeconds: 5
            successThreshold: 1
            timeoutSeconds: 1
          resources:
            limits:
              cpu: 'repl{{ ConfigOption "verification_cpu" }}'
              memory: 'repl{{ ConfigOption "verification_pod_memory" }}Mi'
            requests:
              cpu: 'repl{{ ConfigOption "verification_cpu" }}'
              memory: 'repl{{ ConfigOption "verification_pod_memory" }}Mi'
      restartPolicy: Always
      volumes:
        - name: verification-svc
          secret:
            secretName: verification-svc
            items:
              - key: MONGO_URI
                path: MONGO_URI

---